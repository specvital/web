openapi: 3.1.0
info:
  title: Specvital API
  description: Test specification analysis service for GitHub repositories
  version: 1.0.0

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /api/analyze/{owner}/{repo}:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    get:
      operationId: analyzeRepository
      summary: Analyze repository test specifications
      description: |
        Triggers or retrieves analysis for a GitHub repository.
        - Returns completed analysis if available
        - Queues new analysis if not found
        - Returns current status if analysis is in progress
      responses:
        "200":
          description: Analysis completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompletedResponse"
        "202":
          description: Analysis accepted and processing
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/QueuedResponse"
                  - $ref: "#/components/schemas/AnalyzingResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/analyze/{owner}/{repo}/status:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    get:
      operationId: getAnalysisStatus
      summary: Get analysis status
      description: Check the current status of repository analysis
      responses:
        "200":
          description: Analysis status retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalysisResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/login:
    get:
      operationId: authLogin
      summary: Initiate GitHub OAuth login
      description: Redirects to GitHub OAuth authorization page
      responses:
        "200":
          description: OAuth authorization URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/callback:
    get:
      operationId: authCallback
      summary: GitHub OAuth callback
      description: Handles OAuth callback from GitHub and sets authentication cookie
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: OAuth authorization code from GitHub
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: OAuth state for CSRF protection
      responses:
        "302":
          description: Redirect to frontend after successful authentication
          headers:
            Location:
              schema:
                type: string
              description: Frontend URL to redirect to
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only authentication cookie
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/logout:
    post:
      operationId: authLogout
      summary: Logout and clear authentication
      description: Clears authentication cookies and revokes refresh token in database
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/refresh:
    post:
      operationId: authRefresh
      summary: Refresh authentication tokens
      description: |
        Exchanges a valid refresh token for a new access/refresh token pair.
        The old refresh token is invalidated (rotation).
        If a revoked token is used, the entire token family is invalidated (reuse detection).
      responses:
        "200":
          description: Tokens refreshed successfully
          headers:
            Set-Cookie:
              schema:
                type: string
              description: New access and refresh tokens as HTTP-only cookies
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/me:
    get:
      operationId: authMe
      summary: Get current user info
      description: Returns the currently authenticated user's information
      security:
        - cookieAuth: []
      responses:
        "200":
          description: User information retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserInfo"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/bookmarks:
    get:
      operationId: getUserBookmarks
      summary: Get user's bookmarked repositories
      description: Returns list of repositories bookmarked by the authenticated user
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Bookmarked repositories retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookmarkedRepositoriesResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/analyzed-repositories:
    get:
      operationId: getUserAnalyzedRepositories
      summary: Get user's analyzed repositories
      description: Returns paginated list of repositories analyzed by the authenticated user with ownership filtering
      security:
        - cookieAuth: []
      parameters:
        - name: cursor
          in: query
          required: false
          description: Pagination cursor for next page (opaque string from previous response)
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Maximum number of repositories to return per page
        - name: ownership
          in: query
          required: false
          schema:
            type: string
            enum: [all, mine, organization]
            default: all
          description: |
            Filter repositories by ownership:
            - all: All analyzed repositories (personal and organization)
            - mine: Only repositories owned by the user
            - organization: Only repositories owned by organizations
      responses:
        "200":
          description: Analyzed repositories retrieved with pagination
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserAnalyzedRepositoriesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/repositories/recent:
    get:
      operationId: getRecentRepositories
      summary: Get recently analyzed repositories
      description: |
        Returns paginated list of analyzed repositories.
        Supports cursor-based pagination, sorting, and view filtering.
        - Default behavior (no params): Returns first 20 items sorted by recent analysis
        - Backward compatible: Existing clients work without changes
        - Authentication: Optional for view=community/all with ownership=all. Required for view=my or ownership=mine/organization.
      security:
        - cookieAuth: []
        - {}
      parameters:
        - name: cursor
          in: query
          required: false
          description: Pagination cursor for next page (opaque string from previous response)
          schema:
            type: string
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Maximum number of repositories to return per page
        - name: sortBy
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/SortByParam"
          description: Field to sort by (default is recent)
        - name: sortOrder
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/SortOrderParam"
          description: Sort direction (default depends on sortBy - desc for recent/tests, asc for name)
        - name: view
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/ViewFilterParam"
          description: Filter repositories by analyzer (who analyzed the repository)
        - name: ownership
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/OwnershipFilterParam"
          description: Filter repositories by ownership type
      responses:
        "200":
          description: Repositories retrieved with pagination info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedRepositoriesResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/repositories/stats:
    get:
      operationId: getRepositoryStats
      summary: Get repository statistics
      description: Returns aggregate statistics for user's repositories
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Statistics retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RepositoryStatsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/repositories/{owner}/{repo}/bookmark:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    post:
      operationId: addBookmark
      summary: Bookmark a repository
      description: Add repository to user's bookmarks
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Bookmark added successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookmarkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"
    delete:
      operationId: removeBookmark
      summary: Remove bookmark
      description: Remove repository from user's bookmarks
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Bookmark removed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BookmarkResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/repositories/{owner}/{repo}/update-status:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    get:
      operationId: getUpdateStatus
      summary: Check repository update status
      description: |
        Checks if repository has new commits since last analysis.
        Uses git ls-remote to check latest commit SHA.
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Update status retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UpdateStatusResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/repositories/{owner}/{repo}/reanalyze:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    post:
      operationId: reanalyzeRepository
      summary: Trigger repository re-analysis
      description: |
        Queues a new analysis job for the repository.
        Returns job status that can be polled via /api/analyze/{owner}/{repo}/status
      security:
        - cookieAuth: []
      responses:
        "202":
          description: Re-analysis queued successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/QueuedResponse"
                  - $ref: "#/components/schemas/AnalyzingResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/github/repositories:
    get:
      operationId: getUserGitHubRepositories
      summary: Get user's GitHub repositories
      description: Returns all repositories accessible by the authenticated user from GitHub
      security:
        - cookieAuth: []
      parameters:
        - name: refresh
          in: query
          required: false
          description: Force refresh from GitHub API, bypassing cache
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: GitHub repositories retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitHubRepositoriesResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/github/organizations:
    get:
      operationId: getUserGitHubOrganizations
      summary: Get user's GitHub organizations
      description: Returns all organizations the authenticated user belongs to
      security:
        - cookieAuth: []
      parameters:
        - name: refresh
          in: query
          required: false
          description: Force refresh from GitHub API, bypassing cache
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: GitHub organizations retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitHubOrganizationsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/github/organizations/{org}/repositories:
    parameters:
      - name: org
        in: path
        required: true
        description: GitHub organization login name
        schema:
          type: string
          pattern: "^[a-zA-Z0-9._-]+$"
        example: facebook
    get:
      operationId: getOrganizationRepositories
      summary: Get organization's repositories
      description: Returns all repositories in the specified organization
      security:
        - cookieAuth: []
      parameters:
        - name: refresh
          in: query
          required: false
          description: Force refresh from GitHub API, bypassing cache
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: Organization repositories retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitHubRepositoriesResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/github-app/installations:
    get:
      operationId: getUserGitHubAppInstallations
      summary: Get user's GitHub App installations
      description: Returns list of GitHub App installations accessible to the authenticated user
      tags:
        - GitHub App
      security:
        - cookieAuth: []
      responses:
        "200":
          description: GitHub App installations retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitHubAppInstallationsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/user/github-app/install-url:
    get:
      operationId: getGitHubAppInstallUrl
      summary: Get GitHub App installation URL
      description: Returns the URL to install the GitHub App on a GitHub account
      tags:
        - GitHub App
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Installation URL generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GitHubAppInstallUrlResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/webhooks/github-app:
    post:
      operationId: handleGitHubAppWebhook
      summary: Handle GitHub App webhook events
      description: |
        Receives and processes webhook events from GitHub App.
        Handles installation, installation_repositories, and other GitHub App events.
        Webhook signature is verified using HMAC-SHA256.
      tags:
        - Webhooks
      parameters:
        - name: X-GitHub-Event
          in: header
          required: true
          description: GitHub event type (e.g., installation, installation_repositories)
          schema:
            type: string
        - name: X-Hub-Signature-256
          in: header
          required: true
          description: HMAC-SHA256 signature for payload verification
          schema:
            type: string
        - name: X-GitHub-Delivery
          in: header
          required: true
          description: Unique delivery ID for this webhook event
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GitHubWebhookPayload"
      responses:
        "200":
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WebhookResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Invalid webhook signature
          content:
            application/problem+json:
              schema:
                $ref: "#/components/schemas/ProblemDetail"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: JWT token stored in HTTP-only cookie

  parameters:
    Owner:
      name: owner
      in: path
      required: true
      description: GitHub repository owner (user or organization)
      schema:
        type: string
        pattern: "^[a-zA-Z0-9._-]+$"
      example: facebook

    Repo:
      name: repo
      in: path
      required: true
      description: GitHub repository name
      schema:
        type: string
        pattern: "^[a-zA-Z0-9._-]+$"
      example: react

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    InternalError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    Unauthorized:
      description: Authentication required
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

  schemas:
    # Analysis Response - Discriminated Union
    AnalysisResponse:
      oneOf:
        - $ref: "#/components/schemas/CompletedResponse"
        - $ref: "#/components/schemas/AnalyzingResponse"
        - $ref: "#/components/schemas/QueuedResponse"
        - $ref: "#/components/schemas/FailedResponse"
      discriminator:
        propertyName: status
        mapping:
          completed: "#/components/schemas/CompletedResponse"
          analyzing: "#/components/schemas/AnalyzingResponse"
          queued: "#/components/schemas/QueuedResponse"
          failed: "#/components/schemas/FailedResponse"

    CompletedResponse:
      type: object
      required:
        - status
        - data
      properties:
        status:
          type: string
          const: completed
        data:
          $ref: "#/components/schemas/AnalysisResult"

    AnalyzingResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          const: analyzing

    QueuedResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          const: queued

    FailedResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: string
          const: failed
        error:
          type: string
          description: Error message describing the failure

    # Analysis Result
    AnalysisResult:
      type: object
      required:
        - analyzedAt
        - commitSha
        - owner
        - repo
        - suites
        - summary
      properties:
        analyzedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of analysis completion
          example: "2024-01-15T10:30:00Z"
        branchName:
          type: string
          description: Branch name that was analyzed
          example: main
        commitSha:
          type: string
          description: Git commit SHA that was analyzed
          example: "abc123def456"
        committedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of the commit
          example: "2024-01-14T09:00:00Z"
        owner:
          type: string
          description: Repository owner
          example: facebook
        repo:
          type: string
          description: Repository name
          example: react
        suites:
          type: array
          items:
            $ref: "#/components/schemas/TestSuite"
        summary:
          $ref: "#/components/schemas/Summary"

    # Test Suite
    TestSuite:
      type: object
      required:
        - filePath
        - framework
        - suiteName
        - tests
      properties:
        filePath:
          type: string
          description: Path to the test file relative to repository root
          example: src/__tests__/App.test.tsx
        framework:
          $ref: "#/components/schemas/Framework"
        suiteName:
          type: string
          description: Name of the test suite (describe block name)
          example: UserService
        tests:
          type: array
          items:
            $ref: "#/components/schemas/TestCase"

    # Test Case
    TestCase:
      type: object
      required:
        - filePath
        - framework
        - line
        - name
        - status
      properties:
        filePath:
          type: string
          description: Path to the test file
        framework:
          $ref: "#/components/schemas/Framework"
        line:
          type: integer
          minimum: 1
          description: Line number where the test is defined
        modifier:
          type: string
          description: Test modifier (e.g., only, skip)
        name:
          type: string
          description: Test case name
        status:
          $ref: "#/components/schemas/TestStatus"

    # Test Status Enum
    TestStatus:
      type: string
      enum:
        - active
        - focused
        - skipped
        - todo
        - xfail
      description: |
        Test status indicator:
        - active: Normal test that will run
        - focused: Test marked to run exclusively (e.g., it.only)
        - skipped: Test marked to be skipped (e.g., it.skip)
        - todo: Placeholder test to be implemented
        - xfail: Expected to fail (pytest xfail)

    # Framework
    Framework:
      type: string
      description: Testing framework identifier
      example: vitest

    # Summary
    Summary:
      type: object
      required:
        - active
        - focused
        - frameworks
        - skipped
        - todo
        - total
        - xfail
      properties:
        active:
          type: integer
          minimum: 0
          description: Number of active tests
        focused:
          type: integer
          minimum: 0
          description: Number of focused tests
        frameworks:
          type: array
          items:
            $ref: "#/components/schemas/FrameworkSummary"
        skipped:
          type: integer
          minimum: 0
          description: Number of skipped tests
        todo:
          type: integer
          minimum: 0
          description: Number of todo tests
        total:
          type: integer
          minimum: 0
          description: Total number of tests
        xfail:
          type: integer
          minimum: 0
          description: Number of xfail tests

    # Framework Summary
    FrameworkSummary:
      type: object
      required:
        - active
        - focused
        - framework
        - skipped
        - todo
        - total
        - xfail
      properties:
        active:
          type: integer
          minimum: 0
        focused:
          type: integer
          minimum: 0
        framework:
          $ref: "#/components/schemas/Framework"
        skipped:
          type: integer
          minimum: 0
        todo:
          type: integer
          minimum: 0
        total:
          type: integer
          minimum: 0
        xfail:
          type: integer
          minimum: 0

    # RFC 7807 Problem Detail
    ProblemDetail:
      type: object
      required:
        - status
        - title
        - detail
      properties:
        type:
          type: string
          format: uri
          default: about:blank
          description: URI identifying the problem type
        title:
          type: string
          description: Human-readable summary
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
        instance:
          type: string
          description: URI reference identifying the specific occurrence
        rateLimit:
          $ref: "#/components/schemas/RateLimitInfo"

    # Rate Limit Info
    RateLimitInfo:
      type: object
      required:
        - limit
        - remaining
        - resetAt
      properties:
        limit:
          type: integer
          description: Maximum requests allowed per time window
        remaining:
          type: integer
          description: Remaining requests in current window
        resetAt:
          type: integer
          format: int64
          description: Unix timestamp when the rate limit resets

    # Auth Schemas
    LoginResponse:
      type: object
      required:
        - authUrl
      properties:
        authUrl:
          type: string
          format: uri
          description: GitHub OAuth authorization URL to redirect user

    UserInfo:
      type: object
      required:
        - id
        - login
        - avatarUrl
      properties:
        id:
          type: string
          description: Internal user ID
        login:
          type: string
          description: GitHub username
        avatarUrl:
          type: string
          format: uri
          description: GitHub avatar URL
        name:
          type: string
          description: GitHub display name (optional)

    LogoutResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Logout operation result

    RefreshResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Token refresh operation result

    # Repository List Responses
    BookmarkedRepositoriesResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/RepositoryCard"
          description: Bookmarked repositories

    PaginatedRepositoriesResponse:
      type: object
      required:
        - data
        - hasNext
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/RepositoryCard"
          description: Repositories in the current page
        nextCursor:
          type: string
          nullable: true
          description: Cursor for fetching the next page (null if no more pages)
        hasNext:
          type: boolean
          description: Whether more pages are available

    SortByParam:
      type: string
      enum:
        - name
        - recent
        - tests
      default: recent
      description: |
        Field to sort repositories by:
        - name: Repository name (alphabetical)
        - recent: Analysis timestamp (most recent first)
        - tests: Test count (highest first)

    SortOrderParam:
      type: string
      enum:
        - asc
        - desc
      description: |
        Sort direction:
        - asc: Ascending order
        - desc: Descending order
        Defaults depend on sortBy (desc for recent/tests, asc for name)

    ViewFilterParam:
      type: string
      enum:
        - all
        - my
        - community
      default: all
      description: |
        Filter repositories by analyzer (who analyzed):
        - all: All analyzed repositories
        - my: Only repositories analyzed by the current user
        - community: Only repositories analyzed by other users

    OwnershipFilterParam:
      type: string
      enum:
        - all
        - mine
        - organization
      default: all
      description: |
        Filter repositories by ownership type:
        - all: All analyzed repositories (personal and organization)
        - mine: Only repositories owned by the current user
        - organization: Only repositories owned by organizations the user is a member of

    RepositoryStatsResponse:
      type: object
      required:
        - totalRepositories
        - totalTests
      properties:
        totalRepositories:
          type: integer
          minimum: 0
          description: Total number of analyzed repositories for the user
          example: 12
        totalTests:
          type: integer
          minimum: 0
          description: Total number of tests across all repositories
          example: 1543

    UserAnalyzedRepositoriesResponse:
      type: object
      required:
        - data
        - hasNext
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/RepositoryCard"
          description: Analyzed repositories in the current page
        nextCursor:
          type: string
          nullable: true
          description: Cursor for fetching the next page (null if no more pages)
        hasNext:
          type: boolean
          description: Whether more pages are available

    RepositoryCard:
      type: object
      required:
        - id
        - owner
        - name
        - fullName
        - isBookmarked
        - isAnalyzedByMe
        - updateStatus
      properties:
        id:
          type: string
          description: Repository ID
          example: "550e8400-e29b-41d4-a716-446655440000"
        owner:
          type: string
          description: Repository owner (user or organization)
          example: facebook
        name:
          type: string
          description: Repository name
          example: react
        fullName:
          type: string
          description: Full repository name in owner/name format
          example: facebook/react
        isBookmarked:
          type: boolean
          description: Whether the repository is bookmarked by the user
        isAnalyzedByMe:
          type: boolean
          description: Whether the repository was analyzed by the current user
        latestAnalysis:
          $ref: "#/components/schemas/AnalysisSummary"
        updateStatus:
          $ref: "#/components/schemas/UpdateStatus"

    AnalysisSummary:
      type: object
      required:
        - testCount
        - change
        - analyzedAt
        - commitSha
      properties:
        testCount:
          type: integer
          minimum: 0
          description: Total number of tests in the latest analysis
          example: 312
        change:
          type: integer
          description: Change in test count compared to previous analysis
          example: 5
        analyzedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp when analysis was completed
          example: "2024-01-15T10:30:00Z"
        commitSha:
          type: string
          description: Git commit SHA that was analyzed
          example: abc123def456
        testSummary:
          $ref: "#/components/schemas/TestStatusSummary"

    TestStatusSummary:
      type: object
      required:
        - active
        - focused
        - skipped
        - todo
        - xfail
      properties:
        active:
          type: integer
          minimum: 0
          description: Number of active tests
          example: 280
        focused:
          type: integer
          minimum: 0
          description: Number of focused tests (.only())
          example: 2
        skipped:
          type: integer
          minimum: 0
          description: Number of skipped tests (.skip())
          example: 15
        todo:
          type: integer
          minimum: 0
          description: Number of todo tests
          example: 10
        xfail:
          type: integer
          minimum: 0
          description: Number of expected-to-fail tests
          example: 5

    UpdateStatus:
      type: string
      enum:
        - up-to-date
        - new-commits
        - unknown
      description: |
        Repository update status:
        - up-to-date: Latest analysis is current with HEAD
        - new-commits: New commits available since last analysis
        - unknown: Unable to determine status

    UpdateStatusResponse:
      type: object
      required:
        - status
      properties:
        status:
          $ref: "#/components/schemas/UpdateStatus"
        latestCommitSha:
          type: string
          description: Latest commit SHA from remote
          example: def789abc123
        analyzedCommitSha:
          type: string
          description: Commit SHA from last analysis
          example: abc123def456

    BookmarkResponse:
      type: object
      required:
        - success
        - isBookmarked
      properties:
        success:
          type: boolean
          description: Operation success status
        isBookmarked:
          type: boolean
          description: Current bookmark status after the operation

    # GitHub API Responses
    GitHubRepositoriesResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/GitHubRepository"
          description: List of GitHub repositories

    GitHubOrganizationsResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/GitHubOrganization"
          description: List of GitHub organizations

    GitHubRepository:
      type: object
      required:
        - id
        - name
        - fullName
        - owner
        - defaultBranch
        - isPrivate
      properties:
        id:
          type: integer
          format: int64
          description: GitHub repository ID
          example: 10270250
        name:
          type: string
          description: Repository name
          example: react
        fullName:
          type: string
          description: Full repository name in owner/name format
          example: facebook/react
        owner:
          type: string
          description: Repository owner login
          example: facebook
        description:
          type: string
          description: Repository description
        defaultBranch:
          type: string
          description: Default branch name
          example: main
        isPrivate:
          type: boolean
          description: Whether the repository is private
        pushedAt:
          type: string
          format: date-time
          description: Last push timestamp

    GitHubOrganization:
      type: object
      required:
        - id
        - login
        - accessStatus
      properties:
        id:
          type: integer
          format: int64
          description: GitHub organization ID
          example: 69631
        login:
          type: string
          description: Organization login name
          example: facebook
        avatarUrl:
          type: string
          format: uri
          description: Organization avatar URL
        description:
          type: string
          description: Organization description
        accessStatus:
          $ref: "#/components/schemas/OrganizationAccessStatus"

    OrganizationAccessStatus:
      type: string
      enum:
        - accessible
        - restricted
        - pending
      description: |
        Organization repository access status.
        - accessible: GitHub App installed, can access organization repositories
        - restricted: No GitHub App installation, cannot access organization repositories
        - pending: GitHub App installation is suspended

    # GitHub App API Schemas
    GitHubAppInstallationsResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/GitHubAppInstallation"
          description: List of GitHub App installations

    GitHubAppInstallation:
      type: object
      required:
        - id
        - installationId
        - accountType
        - accountId
        - accountLogin
        - createdAt
        - isSuspended
      properties:
        id:
          type: string
          description: Internal installation record ID
        installationId:
          type: integer
          format: int64
          description: GitHub installation ID
        accountType:
          type: string
          enum: [organization, user]
          description: Type of GitHub account
        accountId:
          type: integer
          format: int64
          description: GitHub account ID
        accountLogin:
          type: string
          description: GitHub account login name
        accountAvatarUrl:
          type: string
          format: uri
          description: GitHub account avatar URL
        createdAt:
          type: string
          format: date-time
          description: When the installation was created
        isSuspended:
          type: boolean
          description: Whether the installation is suspended

    GitHubAppInstallUrlResponse:
      type: object
      required:
        - installUrl
      properties:
        installUrl:
          type: string
          format: uri
          description: URL to install the GitHub App

    # GitHub App Webhook Schemas
    GitHubWebhookPayload:
      type: object
      description: |
        GitHub webhook payload. The structure varies by event type.
        This schema represents the common fields; specific event handling uses raw JSON.
      properties:
        action:
          type: string
          description: The action that was performed (e.g., created, deleted, added, removed)
        installation:
          $ref: "#/components/schemas/WebhookInstallation"
        sender:
          $ref: "#/components/schemas/WebhookSender"
        repositories:
          type: array
          items:
            $ref: "#/components/schemas/WebhookRepository"
          description: Repositories affected by the event (for installation_repositories events)
        repositories_added:
          type: array
          items:
            $ref: "#/components/schemas/WebhookRepository"
          description: Repositories added (for installation_repositories.added events)
        repositories_removed:
          type: array
          items:
            $ref: "#/components/schemas/WebhookRepository"
          description: Repositories removed (for installation_repositories.removed events)

    WebhookInstallation:
      type: object
      required:
        - id
        - account
      properties:
        id:
          type: integer
          format: int64
          description: GitHub App installation ID
        account:
          $ref: "#/components/schemas/WebhookAccount"
        suspended_at:
          type: string
          format: date-time
          nullable: true
          description: When the installation was suspended

    WebhookAccount:
      type: object
      required:
        - id
        - login
        - type
      properties:
        id:
          type: integer
          format: int64
          description: GitHub account ID
        login:
          type: string
          description: Account login name
        type:
          type: string
          enum: [User, Organization]
          description: Account type
        avatar_url:
          type: string
          format: uri
          description: Account avatar URL

    WebhookSender:
      type: object
      required:
        - id
        - login
      properties:
        id:
          type: integer
          format: int64
          description: GitHub user ID of the sender
        login:
          type: string
          description: GitHub username of the sender

    WebhookRepository:
      type: object
      required:
        - id
        - name
        - full_name
      properties:
        id:
          type: integer
          format: int64
          description: GitHub repository ID
        name:
          type: string
          description: Repository name
        full_name:
          type: string
          description: Full repository name (owner/repo)
        private:
          type: boolean
          description: Whether the repository is private

    WebhookResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether the webhook was processed successfully
        message:
          type: string
          description: Optional message about the processing result
