openapi: 3.1.0
info:
  title: Specvital API
  description: Test specification analysis service for GitHub repositories
  version: 1.0.0

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /api/analyze/{owner}/{repo}:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    get:
      operationId: analyzeRepository
      summary: Analyze repository test specifications
      description: |
        Triggers or retrieves analysis for a GitHub repository.
        - Returns completed analysis if available
        - Queues new analysis if not found
        - Returns current status if analysis is in progress
      responses:
        "200":
          description: Analysis completed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompletedResponse"
        "202":
          description: Analysis accepted and processing
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/QueuedResponse"
                  - $ref: "#/components/schemas/AnalyzingResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/analyze/{owner}/{repo}/status:
    parameters:
      - $ref: "#/components/parameters/Owner"
      - $ref: "#/components/parameters/Repo"
    get:
      operationId: getAnalysisStatus
      summary: Get analysis status
      description: Check the current status of repository analysis
      responses:
        "200":
          description: Analysis status retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnalysisResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/login:
    get:
      operationId: authLogin
      summary: Initiate GitHub OAuth login
      description: Redirects to GitHub OAuth authorization page
      responses:
        "200":
          description: OAuth authorization URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/callback:
    get:
      operationId: authCallback
      summary: GitHub OAuth callback
      description: Handles OAuth callback from GitHub and sets authentication cookie
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: OAuth authorization code from GitHub
        - name: state
          in: query
          required: true
          schema:
            type: string
          description: OAuth state for CSRF protection
      responses:
        "302":
          description: Redirect to frontend after successful authentication
          headers:
            Location:
              schema:
                type: string
              description: Frontend URL to redirect to
            Set-Cookie:
              schema:
                type: string
              description: HTTP-only authentication cookie
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/logout:
    post:
      operationId: authLogout
      summary: Logout and clear authentication
      description: Clears the authentication cookie
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogoutResponse"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/auth/me:
    get:
      operationId: authMe
      summary: Get current user info
      description: Returns the currently authenticated user's information
      security:
        - cookieAuth: []
      responses:
        "200":
          description: User information retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserInfo"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: JWT token stored in HTTP-only cookie

  parameters:
    Owner:
      name: owner
      in: path
      required: true
      description: GitHub repository owner (user or organization)
      schema:
        type: string
        pattern: "^[a-zA-Z0-9._-]+$"
      example: facebook

    Repo:
      name: repo
      in: path
      required: true
      description: GitHub repository name
      schema:
        type: string
        pattern: "^[a-zA-Z0-9._-]+$"
      example: react

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    InternalError:
      description: Internal server error
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

    Unauthorized:
      description: Authentication required
      content:
        application/problem+json:
          schema:
            $ref: "#/components/schemas/ProblemDetail"

  schemas:
    # Analysis Response - Discriminated Union
    AnalysisResponse:
      oneOf:
        - $ref: "#/components/schemas/CompletedResponse"
        - $ref: "#/components/schemas/AnalyzingResponse"
        - $ref: "#/components/schemas/QueuedResponse"
        - $ref: "#/components/schemas/FailedResponse"
      discriminator:
        propertyName: status
        mapping:
          completed: "#/components/schemas/CompletedResponse"
          analyzing: "#/components/schemas/AnalyzingResponse"
          queued: "#/components/schemas/QueuedResponse"
          failed: "#/components/schemas/FailedResponse"

    CompletedResponse:
      type: object
      required:
        - status
        - data
      properties:
        status:
          type: string
          const: completed
        data:
          $ref: "#/components/schemas/AnalysisResult"

    AnalyzingResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          const: analyzing

    QueuedResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          const: queued

    FailedResponse:
      type: object
      required:
        - status
        - error
      properties:
        status:
          type: string
          const: failed
        error:
          type: string
          description: Error message describing the failure

    # Analysis Result
    AnalysisResult:
      type: object
      required:
        - analyzedAt
        - commitSha
        - owner
        - repo
        - suites
        - summary
      properties:
        analyzedAt:
          type: string
          format: date-time
          description: ISO 8601 timestamp of analysis completion
          example: "2024-01-15T10:30:00Z"
        commitSha:
          type: string
          description: Git commit SHA that was analyzed
          example: "abc123def456"
        owner:
          type: string
          description: Repository owner
          example: facebook
        repo:
          type: string
          description: Repository name
          example: react
        suites:
          type: array
          items:
            $ref: "#/components/schemas/TestSuite"
        summary:
          $ref: "#/components/schemas/Summary"

    # Test Suite
    TestSuite:
      type: object
      required:
        - filePath
        - framework
        - tests
      properties:
        filePath:
          type: string
          description: Path to the test file relative to repository root
          example: src/__tests__/App.test.tsx
        framework:
          $ref: "#/components/schemas/Framework"
        tests:
          type: array
          items:
            $ref: "#/components/schemas/TestCase"

    # Test Case
    TestCase:
      type: object
      required:
        - filePath
        - framework
        - line
        - name
        - status
      properties:
        filePath:
          type: string
          description: Path to the test file
        framework:
          $ref: "#/components/schemas/Framework"
        line:
          type: integer
          minimum: 1
          description: Line number where the test is defined
        modifier:
          type: string
          description: Test modifier (e.g., only, skip)
        name:
          type: string
          description: Test case name
        status:
          $ref: "#/components/schemas/TestStatus"

    # Test Status Enum
    TestStatus:
      type: string
      enum:
        - active
        - focused
        - skipped
        - todo
        - xfail
      description: |
        Test status indicator:
        - active: Normal test that will run
        - focused: Test marked to run exclusively (e.g., it.only)
        - skipped: Test marked to be skipped (e.g., it.skip)
        - todo: Placeholder test to be implemented
        - xfail: Expected to fail (pytest xfail)

    # Framework
    Framework:
      type: string
      description: Testing framework identifier
      example: vitest

    # Summary
    Summary:
      type: object
      required:
        - active
        - focused
        - frameworks
        - skipped
        - todo
        - total
        - xfail
      properties:
        active:
          type: integer
          minimum: 0
          description: Number of active tests
        focused:
          type: integer
          minimum: 0
          description: Number of focused tests
        frameworks:
          type: array
          items:
            $ref: "#/components/schemas/FrameworkSummary"
        skipped:
          type: integer
          minimum: 0
          description: Number of skipped tests
        todo:
          type: integer
          minimum: 0
          description: Number of todo tests
        total:
          type: integer
          minimum: 0
          description: Total number of tests
        xfail:
          type: integer
          minimum: 0
          description: Number of xfail tests

    # Framework Summary
    FrameworkSummary:
      type: object
      required:
        - active
        - focused
        - framework
        - skipped
        - todo
        - total
        - xfail
      properties:
        active:
          type: integer
          minimum: 0
        focused:
          type: integer
          minimum: 0
        framework:
          $ref: "#/components/schemas/Framework"
        skipped:
          type: integer
          minimum: 0
        todo:
          type: integer
          minimum: 0
        total:
          type: integer
          minimum: 0
        xfail:
          type: integer
          minimum: 0

    # RFC 7807 Problem Detail
    ProblemDetail:
      type: object
      required:
        - status
        - title
        - detail
      properties:
        type:
          type: string
          format: uri
          default: about:blank
          description: URI identifying the problem type
        title:
          type: string
          description: Human-readable summary
        status:
          type: integer
          description: HTTP status code
        detail:
          type: string
          description: Human-readable explanation specific to this occurrence
        instance:
          type: string
          description: URI reference identifying the specific occurrence
        rateLimit:
          $ref: "#/components/schemas/RateLimitInfo"

    # Rate Limit Info
    RateLimitInfo:
      type: object
      required:
        - limit
        - remaining
        - resetAt
      properties:
        limit:
          type: integer
          description: Maximum requests allowed per time window
        remaining:
          type: integer
          description: Remaining requests in current window
        resetAt:
          type: integer
          format: int64
          description: Unix timestamp when the rate limit resets

    # Auth Schemas
    LoginResponse:
      type: object
      required:
        - authUrl
      properties:
        authUrl:
          type: string
          format: uri
          description: GitHub OAuth authorization URL to redirect user

    UserInfo:
      type: object
      required:
        - id
        - login
        - avatarUrl
      properties:
        id:
          type: string
          description: Internal user ID
        login:
          type: string
          description: GitHub username
        avatarUrl:
          type: string
          format: uri
          description: GitHub avatar URL
        name:
          type: string
          description: GitHub display name (optional)

    LogoutResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Logout operation result
